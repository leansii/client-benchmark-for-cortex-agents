# Schema Map (Outline)

## 1. Message & Session Entities
1. `Message` — Base chat unit (see OpenAPI component). Includes optional `toolCalls` array.
2. `SessionContext` — Tracks session metadata.
   | Field | Type | Notes |
   | --- | --- | --- |
   | `sessionId` | `uuid` | Generated by proxy; stored client-side in memory only. |
   | `clientVersion` | `string` | Injected at build time. |
   | `createdAt` | `datetime` | Proxy origin. |
3. `StreamEvent` — SSE payload structure.
   | Event Type | Payload Shape | Description |
   | --- | --- | --- |
   | `token` | `{ type: "token", delta: string, index: number }` | Incremental assistant token. |
   | `tool_call` | `{ type: "tool_call", call: ToolCall }` | Tool request notification. |
   | `final` | `{ type: "final", message: Message, sources: Source[] }` | Stream completion. |
   | `error` | `{ type: "error", code: string, message: string }` | Terminal failure. |

Decisions:
- Use shared union `StreamEvent` to drive client render logic.
Open Questions:
- Should heartbeat events (`commentary`) be formalized?
Next Steps:
- Encode `StreamEvent` union in TypeScript + zod.

## 2. Tool Requests & Responses (Draft)
### 2.1 `cortex_search`
- **Request Schema (`ToolRequestSearch`)**
  | Field | Type | Constraints |
  | --- | --- | --- |
  | `query` | string | 1-512 chars |
  | `filters` | object | Optional, placeholder for facets |
  | `topK` | integer | 1-10 |
- **Response Schema (`ToolResponseSearch`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `results` | array<SearchResult> | 1-10 items |
  | `latencyMs` | integer | For metrics |
  - `SearchResult` fields: `title`, `snippet`, `sourceUrl`, `confidence` (0-1).

### 2.2 `cortex_analyst_text_to_sql`
- **Request (`ToolRequestAnalyst`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `question` | string | 1-512 chars |
  | `schemaContext` | array<TableDef> | Max 20 tables |
- **Response (`ToolResponseAnalyst`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `sql` | string | Parameterized preferred |
  | `confidence` | number | 0..1 |
  | `explanations` | array<string> | Optional rationale |

### 2.3 `sql_exec`
- **Request (`ToolRequestSqlExec`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `sql` | string | Validated/escaped at proxy |
  | `sessionId` | uuid | Matches chat session |
  | `limit` | integer | Optional, <=500 |
- **Response (`ToolResponseSqlExec`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `columns` | array<ColumnMeta> | Column name + type |
  | `rows` | array<array<any>> | Tabular data |
  | `rowCount` | integer | Actual rows returned |
  | `latencyMs` | integer | Observability |

### 2.4 `data_to_chart`
- **Request (`ToolRequestDataToChart`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `data` | object | Schema-aligned dataset |
  | `chartType` | enum | `bar`, `line`, `table` |
  | `options` | object | Optional tuning |
- **Response (`ToolResponseDataToChart`)**
  | Field | Type | Notes |
  | --- | --- | --- |
  | `chartSpec` | object | Vega-Lite/ECharts placeholder |
  | `insights` | array<string> | Summary bullets |
  | `warnings` | array<string> | Data quality notes |

Decisions:
- Tool schemas versioned together; clients must handle warnings gracefully.
Open Questions:
- Do tool responses need trace IDs per call?
Next Steps:
- Draft zod schemas mirroring these outlines.

## 3. Error Handling & Metadata
1. `ErrorResponse` — already defined; add `retryAfterSec` optional for throttling.
2. `TelemetryEvent` — outline for metrics ingestion.
   | Field | Type | Notes |
   | --- | --- | --- |
   | `runId` | uuid | Provided by bench harness |
   | `client` | enum | `react` or `vue` |
   | `metric` | string | Metric name |
   | `value` | number | Raw value |
   | `timestamp` | datetime | ISO-8601 |
3. `LogContext` — ensures redaction fields tracked.

Decisions:
- Telemetry schema extends to bench package for CSV sync.
Open Questions:
- Need PII classification levels for logs/telemetry?
Next Steps:
- Coordinate with security to finalize classification tags.

## 4. Versioning Strategy
- Semantic version per schema group (`chat@1.0.0`, `tools@1.0.0`).
- Breaking changes bump major, clients + proxy release together.
- Use `changeset` metadata to flag contract updates.

Decisions:
- Store schema metadata in `packages/shared/src/meta/schemaVersions.ts` (future).
Open Questions:
- Should we support downgrades (proxy serving v0 + v1 simultaneously)?
Next Steps:
- Document negotiation mechanism if multi-version support required.
